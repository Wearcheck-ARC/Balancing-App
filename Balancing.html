<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#8b1c1c">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WearCheck In-Situ Balancing</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root {
  --bg: #0f0f0f;
  --card: #1a1a1a;
  --text: #f2f2f2;
  --muted: #b0b0b0;
  --accent: #8b1c1c;
}
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

body {
  margin: 0;
  padding: 12px;
  font-family: Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

.logo {
  display: block;
  margin: 10px auto 5px auto;
  width: 90px;
}

.tagline {
  text-align: center;
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 15px;
}

.card {
  background: var(--card);
  border-left: 4px solid var(--accent);
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 12px;
}

.card h3 {
  margin: 0 0 6px 0;
  font-size: 14px;
  color: var(--accent);
  text-transform: uppercase;
}

input, select, button {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  font-size: 15px;
  background: #111;
  color: var(--text);
  border: 1px solid #333;
  border-radius: 4px;
}

button.primary {
  background: var(--accent);
  border: none;
  font-weight: bold;
  margin-top: 10px;
}

button.secondary {
  background: transparent;
  border: 2px solid var(--accent);
  color: var(--accent);
  font-weight: bold;
  margin-top: 6px;
}

button:disabled {
  opacity: 0.4;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
}

td, th {
  border: 1px solid #333;
  padding: 8px;
  text-align: center;
}
</style>
</head>

<body>

<img src="WCK logo no background.png" class="logo">
<div class="tagline">WearCheck – Asset Reliability Care</div>

<div class="card">
  <h3>Job Setup</h3>
  <input id="machine" placeholder="Machine Name">
  <select id="rotation">
    <option value="CW">Rotation: CW (Coupling Side)</option>
    <option value="CCW">Rotation: CCW (Coupling Side)</option>
  </select>
  <input id="blades" type="number" placeholder="Number of Blades">
</div>

<div class="card">
  <h3>Initial Run</h3>
  <input id="A1" type="number" placeholder="Amplitude (mm/s RMS)">
  <input id="P1" type="number" placeholder="Phase (°)">
</div>

<div class="card">
  <h3>Trial Weight</h3>
  <input id="Wt" type="number" placeholder="Trial Weight (g)">
  <input id="WtAng" type="number" placeholder="Trial Weight Angle (°)">
</div>

<div class="card">
  <h3>After Trial</h3>
  <input id="A2" type="number" placeholder="Amplitude (mm/s RMS)">
  <input id="P2" type="number" placeholder="Phase (°)">
</div>

<button class="primary" onclick="calculate()">Calculate Correction</button>
<button class="secondary" onclick="generatePDF()" id="shareBtn" disabled>Share PDF Report</button>

<div class="card" id="output" style="display:none;"></div>

<!-- PDF REPORT -->
<div id="report" style="display:none; width:210mm; background:white; color:black; padding:20mm;"></div>

<script>
function polar(m, d){
  let r = d * Math.PI / 180;
  return {re: m*Math.cos(r), im: m*Math.sin(r)};
}
function mag(c){ return Math.sqrt(c.re*c.re + c.im*c.im); }
function ang(c){
  let a = Math.atan2(c.im, c.re) * 180/Math.PI;
  return a < 0 ? a + 360 : a;
}
function sub(a,b){ return {re:a.re-b.re, im:a.im-b.im}; }
function div(a,b){
  let den = b.re*b.re + b.im*b.im;
  return {
    re:(a.re*b.re + a.im*b.im)/den,
    im:(a.im*b.re - a.re*b.im)/den
  };
}
function norm(p, rot){
  return rot === "CCW" ? (360 - p) % 360 : p;
}
function splitWeights(W, A, n){
  let step = 360/n;
  let i = Math.floor(A/step);
  let t1 = i*step, t2 = ((i+1)%n)*step;
  let r = Math.PI/180;
  return {
    b1: i+1,
    b2: (i+2>n)?1:i+2,
    w1: Math.abs(W*Math.sin((t2-A)*r)/Math.sin((t2-t1)*r)),
    w2: Math.abs(W*Math.sin((A-t1)*r)/Math.sin((t2-t1)*r))
  };
}

let last = {};

function calculate(){
  let rot = rotation.value;
  let V1 = polar(A1.value, norm(P1.value, rot));
  let V2 = polar(A2.value, norm(P2.value, rot));
  let WtV = polar(Wt.value, norm(WtAng.value, rot));

  let IC = div(sub(V2,V1), WtV);
  let Wc = div({re:-V1.re, im:-V1.im}, IC);

  last.W = mag(Wc);
  last.A = ang(Wc);
  last.split = splitWeights(last.W, last.A, blades.value);

  output.style.display = "block";
  output.innerHTML = `
    <h3>Correction Result</h3>
    <b>Total:</b> ${last.W.toFixed(1)} g @ ${last.A.toFixed(0)}°<br><br>
    <table>
      <tr><th>Blade</th><th>Weight (g)</th></tr>
      <tr><td>${last.split.b1}</td><td>${last.split.w1.toFixed(1)}</td></tr>
      <tr><td>${last.split.b2}</td><td>${last.split.w2.toFixed(1)}</td></tr>
    </table>
  `;

  shareBtn.disabled = false;
}

async function generatePDF(){
  const { jsPDF } = window.jspdf;

  report.innerHTML = `
    <div style="text-align:center;">
      <img src="WCK logo no background.png" style="width:110px;">
      <div><b>WearCheck</b> – Asset Reliability Care</div>
      <h2>In-Situ Balancing Report</h2>
      <hr style="border:1px solid #8b1c1c;">
    </div>

    <h3>Job Information</h3>
    <table>
      <tr><td><b>Machine</b></td><td>${machine.value}</td></tr>
      <tr><td><b>Date</b></td><td>${new Date().toLocaleString()}</td></tr>
      <tr><td><b>Rotation</b></td><td>${rotation.value} (Coupling Side)</td></tr>
      <tr><td><b>Blade Count</b></td><td>${blades.value}</td></tr>
      <tr><td><b>Phase Reference</b></td><td>Blade 1 (0°)</td></tr>
    </table>

    <h3>Measurements</h3>
    <table>
      <tr><th>Condition</th><th>Value</th></tr>
      <tr><td>Initial</td><td>${A1.value} mm/s @ ${P1.value}°</td></tr>
      <tr><td>Trial</td><td>${Wt.value} g @ ${WtAng.value}°</td></tr>
      <tr><td>After Trial</td><td>${A2.value} mm/s @ ${P2.value}°</td></tr>
    </table>

    <div style="margin-top:15px; padding:12px; border-left:5px solid #8b1c1c; background:#f5f5f5;">
      <h3>Correction Result</h3>
      <b>Total:</b> ${last.W.toFixed(1)} g @ ${last.A.toFixed(0)}°<br><br>
      <table>
        <tr><th>Blade</th><th>Weight (g)</th></tr>
        <tr><td>${last.split.b1}</td><td>${last.split.w1.toFixed(1)}</td></tr>
        <tr><td>${last.split.b2}</td><td>${last.split.w2.toFixed(1)}</td></tr>
      </table>
    </div>

    <hr>
    <small>Generated by WearCheck In-Situ Balancing App</small>
  `;

  report.style.display = "block";
  const canvas = await html2canvas(report, {scale:2});
  const pdf = new jsPDF("p","mm","a4");
  pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, 0, 210, canvas.height*210/canvas.width);
  pdf.save("WearCheck_Balancing_Report.pdf");
  report.style.display = "none";
}
</script>

</body>
</html>



